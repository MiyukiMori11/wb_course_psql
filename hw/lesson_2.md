# ACID, MVCC, буферный кэш

___

### Задание:

| Done                            | Задание                                                                                                                                  | Результат                                                                                              |
|---------------------------------|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| <input type="checkbox" checked> | Открыть консоль и зайти по ssh на ВМ                                                                                                     | -                                                                                                      |
| <input type="checkbox" checked> | Открыть вторую консоль и также зайти по ssh на ту же ВМ (можно в докере 2 сеанса)                                                        | -                                                                                                      |
| <input type="checkbox" checked> | Запустить везде psql из под пользователя postgres                                                                                        | -                                                                                                      |
| <input type="checkbox" checked> | Сделать в первой сессии новую таблицу и наполнить ее данными                                                                             | -                                                                                                      |
| <input type="checkbox" checked> | Посмотреть текущий уровень изоляции                                                                                                      | read committed ([еще](#Уровень-изоляции))                                                              |
| <input type="checkbox" checked> | Начать новую транзакцию в обеих сессиях с дефолтным (не меняя) уровнем изоляции                                                          | -                                                                                                      |
| <input type="checkbox" checked> | В первой сессии добавить новую запись                                                                                                    | -                                                                                                      |
| <input type="checkbox" checked> | Сделать запрос на выбор всех записей во второй сессии                                                                                    | -                                                                                                      |
| <input type="checkbox" checked> | Видите ли вы новую запись и если да то почему? После задания можете сверить правильный ответ с эталонным (будет доступен после 3 лекции) | Нет, тк уровень изоляции `read committed` ([еще](#default-видимость-новой-записи---uncommited)         |
| <input type="checkbox" checked> | Завершить транзакцию в первом окне                                                                                                       | -                                                                                                      |
| <input type="checkbox" checked> | Сделать запрос на выбор всех записей второй сессии                                                                                       | -                                                                                                      |
| <input type="checkbox" checked> | Видите ли вы новую запись и если да то почему?                                                                                           | Да, тк уровень изоляции `read committed`   ([еще](#default-видимость-новой-записи---commited))         |
| <input type="checkbox" checked> | Завершите транзакцию во второй сессии                                                                                                    | -                                                                                                      |
| <input type="checkbox" checked> | Начать новые транзакции, но уже на уровне repeatable read в ОБЕИХ сессиях                                                                | -                                                                                                      |
| <input type="checkbox" checked> | В первой сессии добавить новую запись                                                                                                    | -                                                                                                      |
| <input type="checkbox" checked> | Сделать запрос на выбор всех записей во второй сессии                                                                                    | -                                                                                                      |
| <input type="checkbox" checked> | Видите ли вы новую запись и если да то почему?                                                                                           | Нет, тк любой уровень выше `read uncommitted` не отобразит непримененные изменения                     |
| <input type="checkbox" checked> | Завершить транзакцию в первом окне                                                                                                       | -                                                                                                      |
| <input type="checkbox" checked> | Сделать запрос во выбор всех записей второй сессии                                                                                       | -                                                                                                      |
| <input type="checkbox" checked> | Видите ли вы новую запись и если да то почему?                                                                                           | Нет, тк уровень изоляции `repeatable read` ([еще](#repeatable-read-видимость-новой-записи---commited)) |

# Подробности

___

### Уровень изоляции

```psql
 transaction_isolation 
-----------------------
 read committed
(1 row)
```

### Default. Видимость новой записи - uncommited

Так как стандартный уровень изоляции postgres - `read committed`,
то в рамках другой сессии мы сможем увидеть только те записи,
для которых изменения уже были применены посредством коммита.
Поэтому пока коммит не был применен в транзакции, где происходила ставка - в рамках других мы новую запись не увидим.

### Default. Видимость новой записи - commited

Несмотря на то, что во второй сессии транзакция не завершена - внутри этой транзакции при повторном запросе всех строк
мы увидим уже
обновленные данные. Причиной этому также является уровень `read committed`, при котором мы при каждом запросе на чтение
видим последнюю актуальную версию записей, для которых был применен commit.

### Repeatable read. Видимость новой записи - commited

При коммите изменений в первой транзакции мы не увидим их во время `SELECT` во второй, так как при уровне изоляции `repeatable read` чтение
идет со снимка данных, совершенного на момент первой операции чтения в рамках этой транзакции. А так как в этой транзакции
первый `SELECT` мы делали **до применения изменений в первой сессии**, то снимок для транзакции будет содержать именно 
то состояние.