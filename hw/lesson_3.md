# Система очистки, журнал предзаписи

___

### Задание:

| Done                            | Задание                                                                                                                               | Результат                                                              |
|---------------------------------|---------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------|
| <input type="checkbox" checked> | Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1 млн строк                           | `INSERT 0 1000000`                                                     |
| <input type="checkbox" checked> | Посмотреть размер файла с таблицей                                                                                                  | `65 MB` ([Подробнее](#размер-таблицы))                                 |
| <input type="checkbox" checked> | 5 раз обновить все строчки и добавить к каждой строчке любой символ                                                                 | -                                                                      |
| <input type="checkbox" checked> | Посмотреть количество мертвых строчек в таблице и когда последний раз приходил    автовакуум                                         | `4999814` ([Подробнее](#мертвые-строки-и-последний-автовакуум))        |
| <input type="checkbox" checked> | Подождать некоторое время, проверяя, пришел ли автовакуум                                                                             | -                                                                      |
| <input type="checkbox" checked> | 5 раз обновить все строчки и добавить к каждой строчке любой символ                                                                 | -                                                                      |
| <input type="checkbox" checked> | Посмотреть размер файла с таблицей                                                                                                  | `415 MB`          ([Подробнее](#размер-таблицы-2))                     |
| <input type="checkbox" checked> | Отключить Автовакуум на конкретной таблице                                                                                           | -                                                                      |
| <input type="checkbox" checked> | 10 раз обновить все строчки и добавить к каждой строчке любой символ                                                                | -                                                                      |
| <input type="checkbox" checked> | Посмотреть размер файла с таблицей                                                                                                  | `841 MB`          ([Подробнее](#размер-таблицы-3))                     |
| <input type="checkbox" checked> | Объясните полученный результат                                                                                                       | Мертвые строки заняли место ([Подробнее](#при-отключении-автовакуума)) |
| <input type="checkbox" checked> | Не забудьте включить автовакуум                                                                                                       | -                                                                      |
| <input type="checkbox" checked> | Написать анонимную процедуру, в которой в цикле 10 раз обновятся все строчки в искомой таблице. Не забыть вывести номер шага цикла. | [Ответ](#процедура)                                                    |

# Подробности

___

### Размер таблицы

```
Schema |    Name    | Type  |  Owner   | Persistence | Access method | Size  | Description
--------+------------+-------+----------+-------------+---------------+-------+-------------
public | some_table | table | postgres | permanent   | heap          | 65 MB | 
```

### Мертвые строки и последний автовакуум

``` 
 relname   | n_live_tup | n_dead_tup | ratio% |        last_autovacuum        
------------+------------+------------+--------+-------------------------------
 some_table |    1000000 |    4999814 |    499 | 2024-10-12 22:15:56.729144+03
 ```

### Размер таблицы 2

```
 Schema |    Name    | Type  |  Owner   | Persistence | Access method |  Size  | Description 
--------+------------+-------+----------+-------------+---------------+--------+-------------
 public | some_table | table | postgres | permanent   | heap          | 415 MB | 

```

### Размер таблицы 3

```
                                      List of relations
 Schema |    Name    | Type  |  Owner   | Persistence | Access method |  Size  | Description 
--------+------------+-------+----------+-------------+---------------+--------+-------------
 public | some_table | table | postgres | permanent   | heap          | 841 MB | 

```

### При отключении автовакуума

В предыдущие разы мы заняли большое количество места только в первый раз, так как при первом апдейте (5 раз) мы не дожидались автовакуума и увеличивали количество мертвых строк.

После этого мы дождались автовакуума и при следующем апдейте по большей части заняли освободившееся после автовакуума место, поэтому таблица в размерах особо не увеличилась (все те же 5 мертвых строк + небольшое увеличение из-за конкатетации).

После отключения автоваккуума мы уже разраслись еще на 5 мертвых строк сверху, так как место не освобождалось.

### Процедура

```postgresql
DO $$
DECLARE
    i INT;
BEGIN
    FOR i IN 1..10 LOOP
        RAISE NOTICE 'Шаг: %', i;
        UPDATE some_table
        SET some_field = some_field || '0'; 
    END LOOP;
END $$;
```